# Unified Access Gateway - GitHub Actions CI
# Verifies build on every push and PR

name: Build & Test

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main]

env:
    GO_VERSION: "1.22"

jobs:
    # Windows build - uses stub.go automatically
    build-windows:
        name: Build (Windows)
        runs-on: windows-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Show repository structure
              shell: pwsh
              run: |
                  Write-Host "==> Repository root:"
                  Get-ChildItem

                  Write-Host "`n==> Deploy directory:"
                  if (Test-Path deploy) { Get-ChildItem deploy } else { Write-Host "deploy/ not found" }

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: ${{ env.GO_VERSION }}

            - name: Download dependencies
              run: |
                  go mod download
                  go mod verify

            - name: Build Windows binary
              shell: pwsh
              run: |
                  Write-Host "==> Building Windows binary..."
                  Write-Host "Note: Using stub.go (no eBPF on Windows)"
                  $env:CGO_ENABLED="0"
                  go build -ldflags="-s -w" -o uag.exe ./cmd/gateway

                  Write-Host "`n==> Build result:"
                  Get-ChildItem uag.exe

    # Linux build - generates eBPF code and builds with eBPF support
    build-linux:
        name: Build (Linux)
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Show repository structure
              run: |
                  echo "==> Repository root:"
                  ls -la

                  echo ""
                  echo "==> Deploy directory:"
                  ls -la deploy/ || echo "deploy/ directory not found!"

            - name: Install eBPF dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y clang-18 llvm-18 libbpf-dev

                  echo "==> Clang-18 version:"
                  clang-18 --version

                  echo "==> Check BPF target support:"
                  clang-18 --print-targets | grep -i bpf || echo "BPF target check"

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: ${{ env.GO_VERSION }}

            - name: Install bpf2go
              run: |
                  go install github.com/cilium/ebpf/cmd/bpf2go@latest
                  echo "==> bpf2go installed"

            - name: Generate eBPF bindings
              run: |
                  cd pkg/ebpf
                  export GOPACKAGE=ebpf

                  echo "==> Generating SockMap eBPF..."
                  bpf2go -cc clang-18 -target bpf -cflags "-O2 -g -Wall" bpf sockmap.c -- -I./include

                  echo "==> Generating XDP eBPF..."
                  bpf2go -cc clang-18 -target bpf -cflags "-O2 -g -Wall" xdp xdp_filter.c -- -I./include

                  echo "==> Generated files:"
                  ls -la *.go

            - name: Download dependencies
              run: |
                  go mod download
                  go mod verify

            - name: Build Linux binary
              run: |
                  echo "==> Building Linux binary with eBPF support..."
                  CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o uag ./cmd/gateway

                  echo ""
                  echo "==> Build result:"
                  ls -lh uag
                  file uag

            - name: Upload binary artifact
              uses: actions/upload-artifact@v4
              with:
                  name: uag-linux-amd64
                  path: uag
                  retention-days: 7

    # Docker build test
    docker:
        name: Docker Build Test
        runs-on: ubuntu-latest
        needs: build-linux

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Download binary
              uses: actions/download-artifact@v4
              with:
                  name: uag-linux-amd64

            - name: Build Docker image
              run: |
                  cat > Dockerfile.ci << 'EOF'
                  FROM alpine:3.19
                  RUN apk --no-cache add ca-certificates tzdata
                  ENV TZ=Asia/Shanghai
                  RUN adduser -D -u 1000 gateway
                  COPY uag /usr/local/bin/uag
                  RUN chmod +x /usr/local/bin/uag
                  USER gateway
                  EXPOSE 8080 9090
                  HEALTHCHECK --interval=30s --timeout=5s --start-period=5s --retries=3 \
                      CMD wget -q --spider http://localhost:9090/health || exit 1
                  ENTRYPOINT ["/usr/local/bin/uag"]
                  EOF

                  docker build -t uag:ci -f Dockerfile.ci .
                  docker images | grep uag

    # Validate K8s manifests
    validate-k8s:
        name: Validate K8s Manifests
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Check deploy files
              run: |
                  echo "==> Deploy directory:"
                  ls -la deploy/ || echo "deploy/ directory not found!"

                  echo ""
                  echo "==> Check key files:"
                  [ -f deploy/namespace.yaml ] && echo "✅ namespace.yaml exists" || echo "❌ namespace.yaml NOT found"
                  [ -f deploy/deployment.yaml ] && echo "✅ deployment.yaml exists" || echo "❌ deployment.yaml NOT found"

            - name: Install kubeval
              run: |
                  wget -q https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
                  tar xf kubeval-linux-amd64.tar.gz
                  sudo mv kubeval /usr/local/bin/

            - name: Validate K8s manifests
              run: |
                  echo "==> Validating Kubernetes manifests..."

                  if [ -d deploy ]; then
                    for file in deploy/*.yaml; do
                      if [ -f "$file" ]; then
                        echo "Validating: $file"
                        kubeval "$file" --strict || echo "Warning: $file has issues"
                      fi
                    done
                  else
                    echo "No deploy/ directory found"
                  fi
              continue-on-error: true
